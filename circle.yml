general:
  branches:
    ignore:
      - gh-pages
      - /pull\/.*/

machine:
  services:
    - docker
  environment:
    GOPATH: /home/ubuntu:$GOPATH
    SRCDIR: /home/ubuntu/src/github.com/weaveworks/scope
    PATH: $PATH:$HOME/.local/bin
    CLOUDSDK_CORE_DISABLE_PROMPTS: 1
    SCOPE_UI_BUILD: $HOME/docker/scope_ui_build.tar

dependencies:
  cache_directories:
    - "~/docker"
  override:
    - sudo apt-get --only-upgrade install tar
    - if [[ -e "$SCOPE_UI_BUILD" ]]; then
        docker load -i $SCOPE_UI_BUILD;
      else
        make scope_ui_build.tar;
        mkdir -p $(dirname "$SCOPE_UI_BUILD");
        mv scope_ui_build.tar $(dirname "$SCOPE_UI_BUILD");
      fi
    - curl https://sdk.cloud.google.com | bash
    - bin/setup-circleci-secrets "$SECRET_PASSWORD"
  post:
    - go version
    - go clean -i net
    - go install -tags netgo std
    - make deps
    - mkdir -p $(dirname $SRCDIR)
    - cp -r $(pwd)/ $SRCDIR

test:
  override:
    - cd $SRCDIR; ./bin/lint .
    - cd $SRCDIR; make client-test
    - cd $SRCDIR; make static
    - cd $SRCDIR; make
    - cd $SRCDIR; ./bin/test -slow
    - cd $SRCDIR/experimental; make
    - cd $SRCDIR/integration; ./gce.sh setup
    - cd $SRCDIR/integration; . ./gce.sh hosts; ./setup.sh
    - cd $SRCDIR/integration; . ./gce.sh hosts; ./run_all.sh:
        timeout: 300
  post:
    - cd $SRCDIR/integration; ./gce.sh destroy
    - goveralls -repotoken $COVERALLS_REPO_TOKEN -coverprofile=$SRCDIR/profile.cov -service=circleci || true
    - cd $SRCDIR; cp coverage.html $CIRCLE_ARTIFACTS
    - cd $SRCDIR; cp scope.tar $CIRCLE_ARTIFACTS

deployment:
  hub:
    branch: master
    owner: weaveworks
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push weaveworks/scope
